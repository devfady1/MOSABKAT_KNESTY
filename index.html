<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>برنامج المسابقة - العباقرة</title>
  <style>
    :root{
      --bg:#0f1724;
      --card:#1a1f2e;
      --accent:#3b82f6;
      --accent-hover:#2563eb;
      --muted:#94a3b8;
      --success:#10b981;
      --error:#ef4444;
      --warning:#f59e0b;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Segoe UI',Tahoma,Arial,'Noto Naskh Arabic',sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:#fff;
      min-height:100vh;
      padding:20px;
    }
    .container{
      max-width:1200px;
      margin:0 auto;
    }
    header{
      text-align:center;
      margin-bottom:30px;
      animation:fadeInDown 0.8s ease;
    }
    header h1{
      font-size:2.5rem;
      margin-bottom:10px;
      text-shadow:2px 2px 4px rgba(0,0,0,0.3);
    }
    header p{
      font-size:1.1rem;
      opacity:0.9;
    }
    .card{
      background:rgba(255,255,255,0.1);
      backdrop-filter:blur(10px);
      padding:25px;
      border-radius:20px;
      box-shadow:0 8px 32px rgba(0,0,0,0.1);
      border:1px solid rgba(255,255,255,0.2);
      animation:fadeIn 0.8s ease;
    }
    label{
      display:block;
      margin-bottom:8px;
      font-weight:500;
      font-size:1.1rem;
    }
    input[type=text]{
      width:100%;
      padding:12px 15px;
      border-radius:10px;
      border:2px solid rgba(255,255,255,0.3);
      background:rgba(255,255,255,0.1);
      color:#fff;
      font-size:1rem;
      transition:all 0.3s ease;
    }
    input[type=text]:focus{
      outline:none;
      border-color:var(--accent);
      background:rgba(255,255,255,0.15);
    }
    input[type=text]::placeholder{
      color:rgba(255,255,255,0.6);
    }
    .row{
      display:flex;
      gap:15px;
      margin-top:15px;
      flex-wrap:wrap;
    }
    button{
      background:var(--accent);
      border:none;
      padding:12px 24px;
      border-radius:10px;
      color:#fff;
      font-size:1rem;
      font-weight:600;
      cursor:pointer;
      transition:all 0.3s ease;
      box-shadow:0 4px 15px rgba(59,130,246,0.4);
    }
    button:hover{
      background:var(--accent-hover);
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(59,130,246,0.5);
    }
    button:disabled{
      opacity:0.5;
      cursor:not-allowed;
    }
    button.secondary{
      background:rgba(255,255,255,0.2);
      box-shadow:none;
    }
    button.secondary:hover{
      background:rgba(255,255,255,0.3);
    }
    button.danger{
      background:var(--error);
      box-shadow:0 4px 15px rgba(239,68,68,0.4);
    }
    button.danger:hover{
      background:#dc2626;
      box-shadow:0 6px 20px rgba(239,68,68,0.5);
    }
    .teams-list{
      margin-top:20px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .team-pill{
      background:rgba(255,255,255,0.2);
      padding:10px 20px;
      border-radius:25px;
      font-weight:500;
      display:flex;
      align-items:center;
      gap:10px;
      animation:slideIn 0.3s ease;
    }
    .team-pill .remove{
      cursor:pointer;
      color:var(--error);
      font-weight:bold;
    }
    .main-grid{
      display:grid;
      grid-template-columns:1fr 350px;
      gap:20px;
      margin-top:20px;
    }
    .question-box{
      min-height:400px;
    }
    .category-selector{
      display:flex;
      gap:10px;
      margin-bottom:20px;
      flex-wrap:wrap;
    }
    .category-btn{
      flex:1;
      min-width:120px;
      padding:15px;
      background:rgba(255,255,255,0.1);
      border:2px solid rgba(255,255,255,0.3);
      border-radius:10px;
      color:#fff;
      font-size:1rem;
      cursor:pointer;
      transition:all 0.3s ease;
      text-align:center;
    }
    .category-btn:hover{
      background:rgba(255,255,255,0.2);
      transform:scale(1.05);
    }
    .category-btn.selected{
      background:var(--accent);
      border-color:var(--accent);
      box-shadow:0 4px 15px rgba(59,130,246,0.4);
    }
    .question-display{
      background:rgba(255,255,255,0.05);
      padding:20px;
      border-radius:15px;
      margin-bottom:20px;
      min-height:100px;
    }
    .question-text{
      font-size:1.3rem;
      line-height:1.6;
      margin-bottom:20px;
    }
    .options{
      display:grid;
      gap:12px;
    }
    .option{
      background:rgba(255,255,255,0.1);
      padding:15px 20px;
      border-radius:10px;
      border:2px solid transparent;
      cursor:pointer;
      transition:all 0.3s ease;
      font-size:1.1rem;
    }
    .option:hover{
      background:rgba(255,255,255,0.15);
      transform:translateX(-5px);
    }
    .option.selected{
      background:var(--accent);
      border-color:var(--accent);
      box-shadow:0 4px 15px rgba(59,130,246,0.4);
    }
    .option.correct{
      background:var(--success);
      border-color:var(--success);
      animation:pulse 0.5s ease;
    }
    .option.wrong{
      background:var(--error);
      border-color:var(--error);
      animation:shake 0.5s ease;
    }
    .scoreboard{
      position:sticky;
      top:20px;
    }
    .score-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:15px;
      border-radius:10px;
      background:rgba(255,255,255,0.1);
      margin-bottom:10px;
      transition:all 0.3s ease;
    }
    .score-item.current{
      background:black;
      box-shadow:0 4px 15px rgba(59,130,246,0.4);
    }
    .score-value{
      font-size:1.5rem;
      font-weight:bold;
    }
    .feedback{
      padding:15px;
      border-radius:10px;
      margin-top:15px;
      font-weight:500;
      text-align:center;
      animation:slideIn 0.3s ease;
    }
    .feedback.success{
      background:var(--success);
    }
    .feedback.error{
      background:var(--error);
    }
    .final-results{
      text-align:center;
      padding:30px;
    }
    .winner-announcement{
      background:linear-gradient(135deg,#667eea,#764ba2);
      padding:30px;
      border-radius:20px;
      margin:20px 0;
      box-shadow:0 10px 40px rgba(0,0,0,0.2);
      animation:bounceIn 1s ease;
    }
    .winner-announcement h2{
      font-size:2rem;
      margin-bottom:15px;
    }
    .trophy{
      font-size:4rem;
      animation:rotate 2s linear infinite;
    }
    .hidden{
      display:none;
    }
    @keyframes fadeIn{
      from{opacity:0;transform:translateY(20px)}
      to{opacity:1;transform:translateY(0)}
    }
    @keyframes fadeInDown{
      from{opacity:0;transform:translateY(-20px)}
      to{opacity:1;transform:translateY(0)}
    }
    @keyframes slideIn{
      from{opacity:0;transform:translateX(-20px)}
      to{opacity:1;transform:translateX(0)}
    }
    @keyframes pulse{
      0%,100%{transform:scale(1)}
      50%{transform:scale(1.05)}
    }
    @keyframes shake{
      0%,100%{transform:translateX(0)}
      25%{transform:translateX(-5px)}
      75%{transform:translateX(5px)}
    }
    @keyframes bounceIn{
      0%{transform:scale(0.3);opacity:0}
      50%{transform:scale(1.05)}
      70%{transform:scale(0.9)}
      100%{transform:scale(1);opacity:1}
    }
    @keyframes rotate{
      from{transform:rotate(0deg)}
      to{transform:rotate(360deg)}
    }
    @media(max-width:768px){
      .main-grid{grid-template-columns:1fr}
      .scoreboard{position:relative}
      header h1{font-size:1.8rem}
    }
  </style>
</head>
<body dir="rtl">
  <div class="container">
    <header>
      <h1>🏆 برنامج المسابقة - العباقرة 🏆</h1>
      <p>تنافس مع فريقك واختبر معلوماتك في مختلف المجالات!</p>
    </header>

    <!-- شاشة إضافة الفرق -->
    <div class="card" id="setup">
      <h2 style="text-align:center;margin-bottom:20px">📝 المرحلة الأولى: تسجيل الفرق</h2>
      <label>أدخل أسماء الفرق المشاركة:</label>
      <div class="row">
        <input id="teamName" type="text" placeholder="اكتب اسم الفريق ثم اضغط إضافة" onkeypress="if(event.key==='Enter')addTeam()" />
        <button id="addTeamBtn" onclick="addTeam()">➕ إضافة فريق</button>
      </div>
      <div class="teams-list" id="teamsList"></div>
      <div style="text-align:center;margin-top:30px">
        <button id="startBtn" class="secondary" onclick="startGame()" style="display:none;font-size:1.2rem;padding:15px 40px">
          🚀 ابدأ المسابقة
        </button>
      </div>
      <div style="margin-top:20px;text-align:center;opacity:0.8">
        💡 يمكنك إضافة فريقين أو أكثر • الأسئلة لن تتكرر • المسابقة تحتوي على 20 سؤال
      </div>
      <div style="margin-top:15px;text-align:center">
        <button class="danger" onclick="clearAllData()" style="font-size:0.9rem;padding:8px 15px">🗑️ مسح كل البيانات المحفوظة</button>
      </div>
    </div>

    <!-- شاشة اللعب -->
    <div id="game" class="hidden">
      <div class="main-grid">
        <div>
          <!-- بطاقة السؤال -->
          <div class="question-box card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
              <div>
                <h3 id="turnLabel" style="color:white">دور الفريق: -</h3>
                <div style="margin-top:5px;opacity:0.8" id="remaining">الأسئلة المتبقية: 20</div>
              </div>
              <div id="questionNumber" style="font-size:1.5rem;font-weight:bold;opacity:0.5">
                السؤال #<span id="qNum">0</span>
              </div>
            </div>

            <!-- اختيار القسم -->
            <div class="category-selector" id="categorySelector">
              <div class="category-btn" data-category="dini" onclick="selectCategory('dini')">
                ✝️ ديني
              </div>
              <div class="category-btn" data-category="geo" onclick="selectCategory('geo')">
                🌍 جغرافيا
              </div>
              <div class="category-btn" data-category="sport" onclick="selectCategory('sport')">
                ⚽ رياضة
              </div>
              <div class="category-btn" data-category="science" onclick="selectCategory('science')">
                🔬 علوم وثقافة
              </div>
            </div>

            <!-- عرض السؤال -->
            <div class="question-display hidden" id="questionDisplay">
              <div class="question-text" id="qText"></div>
              <div class="options" id="options"></div>
              <div class="row" style="margin-top:20px;justify-content:center">
                <button id="submitBtn" onclick="submitAnswer()" style="min-width:200px">✅ تأكيد الإجابة</button>
                <button id="nextBtn" class="secondary hidden" onclick="nextTurn()">السؤال التالي ➡️</button>
              </div>
            </div>

            <!-- رسالة اختيار القسم -->
            <div id="selectCategoryMsg" style="text-align:center;padding:40px;opacity:0.7">
              👆 اختر قسم السؤال من الأعلى
            </div>
          </div>

          <!-- بطاقة الملاحظات -->
          <div class="card" style="margin-top:20px">
            <div id="feedback"></div>
          </div>
        </div>

        <!-- لوحة النتائج -->
        <aside class="scoreboard">
          <div class="card">
            <h3 style="text-align:center;margin-bottom:20px">📊 لوحة النتائج</h3>
            <div id="scores"></div>
            <hr style="margin:20px 0;opacity:0.2" />
            <div style="text-align:center">
              <button onclick="saveManually()" style="width:100%;background:var(--success)">💾 حفظ اللعبة</button>
              <button class="danger" onclick="endGame()" style="width:100%;margin-top:10px">🏁 إنهاء المسابقة</button>
              <button class="secondary" onclick="resetGame()" style="width:100%;margin-top:10px">🔄 بداية جديدة</button>
            </div>
            <div id="saveStatus" style="margin-top:10px;text-align:center;font-size:0.9rem;opacity:0.8"></div>
          </div>
        </aside>
      </div>
    </div>

    <!-- شاشة النتائج النهائية -->
    <div id="final" class="hidden">
      <div class="card final-results">
        <h2 style="margin-bottom:30px">🎊 النتائج النهائية 🎊</h2>
        <div id="finalScores"></div>
        <div class="winner-announcement" id="winnerAnnouncement">
          <div class="trophy">🏆</div>
          <h2 id="winnerText"></h2>
        </div>
        <button onclick="resetGame()" style="margin-top:30px;padding:15px 40px;font-size:1.2rem">
          🔄 مسابقة جديدة
        </button>
      </div>
    </div>
  </div>

  <script>
    // قاعدة بيانات الأسئلة
    const QUESTIONS = {
      dini: [
        {q:'من هو الكاهن الذي بارك إبراهيم بعدما رجع من الحرب؟', opts:['صموئيل','هارون','عزريا','ملشيصادق'], a:3},
        {q:'في أي سفر وردت عبارة "باطل الأباطيل الكل باطل"؟', opts:['الأمثال','أيوب','المزامير','الجامعة'], a:3},
        {q:'من هو كاتب إنجيل وسفر أعمال الرسل؟', opts:['بولس','لوقا','بطرس','يوحنا'], a:1},
        {q:'في أي مدينة دُعي التلاميذ أولاً مسيحيين؟', opts:['أورشليم','أنطاكية','أفسس','كورنثوس'], a:1},
        {q:'أي من هذه الرسائل كتبها الرسول بولس من السجن؟', opts:['غلاطية','أفسس','تسالونيكي الأولى','رومية'], a:1}
      ],
      geo: [
        {q:'ما هي أطول أنهار العالم؟', opts:['النيل','الأمازون','اليانغتسي','الميسيسيبي'], a:0},
        {q:'ما هي أكبر صحراء في العالم؟', opts:['صحراء جوبي','الصحراء الكبرى','صحراء ألاسكا','الربع الخالي'], a:1},
        {q:'أي قارة تضم أكبر عدد من الدول؟', opts:['آسيا','أفريقيا','أوروبا','أمريكا الجنوبية'], a:1},
        {q:'ما هي عاصمة المغرب؟', opts:['الدار البيضاء','مراكش','الرباط','فاس'], a:2},
        {q:'في أي دولة توجد جبال الألب؟', opts:['إيطاليا','فرنسا','سويسرا','النمسا'], a:2}
      ],
      sport: [
        {q:'من هو أصغر لاعب أحرز هدفًا في كأس العالم؟', opts:['مارادونا','كليان مبابي','مايكل أوين','بيليه'], a:3},
        {q:'أي منتخب فاز بكأس الأمم الأفريقية 2019؟', opts:['مصر','الجزائر','الكاميرون','نيجيريا'], a:1},
        {q:'كم عدد المرات التي فازت بها البرازيل بكأس العالم حتى 2022؟', opts:['3','4','5','6'], a:2},
        {q:'أي فريق فاز بأول بطولة دوري أبطال أوروبا؟', opts:['بايرن ميونخ','ريال مدريد','ميلان','بنفيكا'], a:1},
        {q:'من هو لاعب كرة القدم الملقب بـ "الظاهرة"؟', opts:['رونالدينيو','رونالدو نازاريو','روماريو','كاكا'], a:1}
      ],
      science: [
        {q:'ما هو أسرع طائر في العالم؟', opts:['النسر','الصقر الجوال','البومة','الطاووس'], a:1},
        {q:'ما هو الحيوان الذي ينام واقفًا؟', opts:['الجمل','الحصان','الفيل','الزرافة'], a:1},
        {q:'ما هو العنصر الكيميائي الذي يرمز له بالرمز Au؟', opts:['فضة','ذهب','نحاس','حديد'], a:1},
        {q:'أي دولة معروفة بصناعة السوشي؟', opts:['الصين','اليابان','كوريا الجنوبية','تايلاند'], a:1},
        {q:'ما هي اللغة الأكثر انتشارًا في العالم؟', opts:['الإنجليزية','الإسبانية','الصينية','العربية'], a:0}
      ]
    };

    // متغيرات اللعبة
    let teams = [];
    let scores = {};
    let currentTeamIndex = 0;
    let usedQuestions = new Set();
    let currentQuestion = null;
    let selectedCategory = null;
    let questionCount = 0;
    let selectedAnswer = null;

    // استرجاع البيانات المحفوظة عند تحميل الصفحة
    window.addEventListener('load', () => {
      loadGameState();
    });

    // حفظ حالة اللعبة في Local Storage
    function saveGameState() {
      const gameState = {
        teams: teams,
        scores: scores,
        currentTeamIndex: currentTeamIndex,
        usedQuestions: Array.from(usedQuestions),
        questionCount: questionCount,
        timestamp: new Date().toISOString()
      };
      localStorage.setItem('quizGameState', JSON.stringify(gameState));
    }

    // استرجاع حالة اللعبة من Local Storage
    function loadGameState() {
      const savedState = localStorage.getItem('quizGameState');
      if (savedState) {
        try {
          const state = JSON.parse(savedState);
          
          // عرض رسالة للمستخدم
          const lastSave = new Date(state.timestamp);
          const timeAgo = getTimeAgo(lastSave);
          
          if (confirm(`🔄 توجد لعبة محفوظة من ${timeAgo}\n\nالفرق: ${state.teams.join(', ')}\nعدد الأسئلة المجابة: ${state.usedQuestions.length}\n\nهل تريد استكمال اللعبة السابقة؟`)) {
            // استرجاع البيانات
            teams = state.teams || [];
            scores = state.scores || {};
            currentTeamIndex = state.currentTeamIndex || 0;
            usedQuestions = new Set(state.usedQuestions || []);
            questionCount = state.questionCount || 0;
            
            // إذا كانت هناك فرق، اعرضها
            if (teams.length > 0) {
              renderTeams();
              if (teams.length >= 2) {
                document.getElementById('startBtn').style.display = 'inline-block';
              }
              
              // إذا كانت اللعبة قد بدأت
              if (usedQuestions.size > 0) {
                document.getElementById('setup').classList.add('hidden');
                document.getElementById('game').classList.remove('hidden');
                updateTurnDisplay();
                renderScores();
                document.getElementById('qNum').textContent = questionCount;
                document.getElementById('remaining').textContent = `الأسئلة المتبقية: ${20 - usedQuestions.size}`;
              }
            }
          } else {
            // المستخدم اختار عدم الاستكمال
            clearGameState();
          }
        } catch (e) {
          console.error('خطأ في استرجاع البيانات:', e);
          clearGameState();
        }
      }
    }

    // حساب الوقت المنقضي
    function getTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      
      if (seconds < 60) return 'قبل ثوانٍ';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `قبل ${minutes} دقيقة`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `قبل ${hours} ساعة`;
      const days = Math.floor(hours / 24);
      return `قبل ${days} يوم`;
    }

    // مسح البيانات المحفوظة
    function clearGameState() {
      localStorage.removeItem('quizGameState');
      teams = [];
      scores = {};
      currentTeamIndex = 0;
      usedQuestions = new Set();
      questionCount = 0;
      selectedAnswer = null;
    }

    // وظائف إدارة الفرق
    function addTeam() {
      const input = document.getElementById('teamName');
      const name = input.value.trim();
      
      if (!name) {
        alert('⚠️ من فضلك اكتب اسم الفريق');
        return;
      }
      
      if (teams.includes(name)) {
        alert('⚠️ هذا الفريق موجود بالفعل!');
        return;
      }
      
      teams.push(name);
      scores[name] = 0;
      input.value = '';
      renderTeams();
      
      if (teams.length >= 2) {
        document.getElementById('startBtn').style.display = 'inline-block';
      }
      
      // حفظ الحالة
      saveGameState();
    }

    function removeTeam(name) {
      teams = teams.filter(t => t !== name);
      delete scores[name];
      renderTeams();
      
      if (teams.length < 2) {
        document.getElementById('startBtn').style.display = 'none';
      }
      
      // حفظ الحالة
      saveGameState();
    }

    function renderTeams() {
      const container = document.getElementById('teamsList');
      container.innerHTML = '';
      
      teams.forEach(team => {
        const pill = document.createElement('div');
        pill.className = 'team-pill';
        pill.innerHTML = `${team} <span class="remove" onclick="removeTeam('${team}')">❌</span>`;
        container.appendChild(pill);
      });
    }

    // بدء اللعبة
    function startGame() {
      if (teams.length < 1) {
        alert('⚠️ يجب إضافة فريق واحد على الأقل');
        return;
      }
      
      document.getElementById('setup').classList.add('hidden');
      document.getElementById('game').classList.remove('hidden');
      
      currentTeamIndex = 0;
      updateTurnDisplay();
      renderScores();
      
      // حفظ الحالة
      saveGameState();
    }

    // اختيار القسم
    function selectCategory(category) {
      selectedCategory = category;
      
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      document.querySelector(`[data-category="${category}"]`).classList.add('selected');
      
      const question = getRandomQuestion(category);
      
      if (!question) {
        alert('⚠️ لا توجد أسئلة متبقية في هذا القسم! جرب قسم آخر.');
        return;
      }
      
      currentQuestion = question;
      displayQuestion(question);
    }

    // سحب سؤال عشوائي
    function getRandomQuestion(category) {
      const categoryQuestions = QUESTIONS[category];
      const availableQuestions = [];
      
      categoryQuestions.forEach((q, index) => {
        const questionId = `${category}-${index}`;
        if (!usedQuestions.has(questionId)) {
          availableQuestions.push({...q, id: questionId, index});
        }
      });
      
      if (availableQuestions.length === 0) return null;
      
      const randomIndex = Math.floor(Math.random() * availableQuestions.length);
      const question = availableQuestions[randomIndex];
      usedQuestions.add(question.id);
      
      // حفظ الحالة بعد سحب سؤال جديد
      saveGameState();
      
      return question;
    }

    // عرض السؤال
    function displayQuestion(question) {
      questionCount++;
      document.getElementById('qNum').textContent = questionCount;
      document.getElementById('remaining').textContent = `الأسئلة المتبقية: ${20 - usedQuestions.size}`;
      
      document.getElementById('selectCategoryMsg').classList.add('hidden');
      document.getElementById('categorySelector').classList.add('hidden');
      document.getElementById('questionDisplay').classList.remove('hidden');
      
      document.getElementById('qText').textContent = question.q;
      
      const optionsContainer = document.getElementById('options');
      optionsContainer.innerHTML = '';
      
      question.opts.forEach((option, index) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'option';
        optionDiv.textContent = `${index + 1}. ${option}`;
        optionDiv.onclick = () => selectAnswer(index, optionDiv);
        optionsContainer.appendChild(optionDiv);
      });
      
      selectedAnswer = null;
      document.getElementById('submitBtn').disabled = false;
      document.getElementById('nextBtn').classList.add('hidden');
    }

    // اختيار إجابة
    function selectAnswer(index, element) {
      document.querySelectorAll('.option').forEach(opt => {
        opt.classList.remove('selected');
      });
      
      element.classList.add('selected');
      selectedAnswer = index;
    }

    // تأكيد الإجابة
    function submitAnswer() {
      if (selectedAnswer === null) {
        alert('⚠️ من فضلك اختر إجابة أولاً');
        return;
      }
      
      const correct = currentQuestion.a;
      const team = teams[currentTeamIndex];
      const feedbackDiv = document.getElementById('feedback');
      
      document.getElementById('submitBtn').disabled = true;
      
      document.querySelectorAll('.option').forEach((opt, index) => {
        if (index === correct) {
          opt.classList.add('correct');
        } else if (index === selectedAnswer && selectedAnswer !== correct) {
          opt.classList.add('wrong');
        }
      });
      
      if (selectedAnswer === correct) {
        scores[team]++;
        feedbackDiv.innerHTML = `<div class="feedback success">🎉 إجابة صحيحة! نقطة لفريق ${team}</div>`;
      } else {
        feedbackDiv.innerHTML = `<div class="feedback error">❌ إجابة خاطئة! الإجابة الصحيحة: ${currentQuestion.opts[correct]}</div>`;
      }
      
      renderScores();
      
      // حفظ الحالة بعد كل إجابة
      saveGameState();
      document.getElementById('nextBtn').classList.remove('hidden');
      
      if (usedQuestions.size >= 20) {
        setTimeout(endGame, 2000);
      }
    }

    // الانتقال للدور التالي
    function nextTurn() {
      document.getElementById('feedback').innerHTML = '';
      currentTeamIndex = (currentTeamIndex + 1) % teams.length;
      updateTurnDisplay();
      
      // حفظ الحالة
      saveGameState();
      
      document.getElementById('categorySelector').classList.remove('hidden');
      document.getElementById('questionDisplay').classList.add('hidden');
      document.getElementById('selectCategoryMsg').classList.remove('hidden');
      
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
    }

    // تحديث عرض الدور
    function updateTurnDisplay() {
      const team = teams[currentTeamIndex];
      document.getElementById('turnLabel').textContent = `دور الفريق: ${team}`;
      
      document.querySelectorAll('.score-item').forEach((item, index) => {
        if (index === currentTeamIndex) {
          item.classList.add('current');
        } else {
          item.classList.remove('current');
        }
      });
    }

    // عرض النتائج
    function renderScores() {
      const container = document.getElementById('scores');
      container.innerHTML = '';
      
      const sortedTeams = [...teams].sort((a, b) => scores[b] - scores[a]);
      
      sortedTeams.forEach((team, index) => {
        const scoreItem = document.createElement('div');
        scoreItem.className = 'score-item';
        if (team === teams[currentTeamIndex]) {
          scoreItem.classList.add('current');
        }
        
        let medal = '';
        if (index === 0 && scores[team] > 0) medal = '🥇 ';
        else if (index === 1 && scores[team] > 0) medal = '🥈 ';
        else if (index === 2 && scores[team] > 0) medal = '🥉 ';
        
        scoreItem.innerHTML = `
          <div>${medal}${team}</div>
          <div class="score-value">${scores[team]}</div>
        `;
        container.appendChild(scoreItem);
      });
    }

    // إنهاء اللعبة
    function endGame() {
      if (usedQuestions.size < 20) {
        if (!confirm('⚠️ لم تنته جميع الأسئلة بعد. هل تريد إنهاء المسابقة الآن؟')) {
          return;
        }
      }
      
      document.getElementById('game').classList.add('hidden');
      document.getElementById('final').classList.remove('hidden');
      
      const finalScoresDiv = document.getElementById('finalScores');
      const sortedTeams = [...teams].sort((a, b) => scores[b] - scores[a]);
      
      let scoresHTML = '<div style="font-size:1.2rem">';
      sortedTeams.forEach((team, index) => {
        let medal = '';
        if (index === 0) medal = '🥇';
        else if (index === 1) medal = '🥈';
        else if (index === 2) medal = '🥉';
        
        scoresHTML += `
          <div style="display:flex;justify-content:space-between;padding:15px;background:rgba(255,255,255,0.1);border-radius:10px;margin-bottom:10px">
            <div>${medal} ${team}</div>
            <div style="font-weight:bold;font-size:1.5rem">${scores[team]} نقطة</div>
          </div>
        `;
      });
      scoresHTML += '</div>';
      finalScoresDiv.innerHTML = scoresHTML;
      
      const maxScore = Math.max(...Object.values(scores));
      const winners = teams.filter(team => scores[team] === maxScore);
      const winnerText = document.getElementById('winnerText');
      
      if (winners.length === 1) {
        winnerText.textContent = `الفائز: ${winners[0]} بـ ${maxScore} نقطة!`;
      } else {
        winnerText.textContent = `تعادل بين: ${winners.join(' و ')} بـ ${maxScore} نقطة!`;
      }
    }

    // إعادة تعيين اللعبة
    function resetGame() {
      if (confirm('⚠️ هل تريد بدء مسابقة جديدة؟ سيتم مسح كل التقدم الحالي.')) {
        clearGameState();
        location.reload();
      }
    }
    
    // مسح كل البيانات
    function clearAllData() {
      if (confirm('⚠️ هل أنت متأكد من مسح كل البيانات المحفوظة؟\n\nسيتم مسح:\n• جميع الفرق المسجلة\n• النقاط\n• تقدم اللعبة الحالي')) {
        clearGameState();
        alert('✅ تم مسح جميع البيانات المحفوظة بنجاح');
        location.reload();
      }
    }
    
    // حفظ يدوي
    function saveManually() {
      saveGameState();
      showSaveStatus('✅ تم حفظ اللعبة بنجاح');
    }
    
    // عرض حالة الحفظ
    function showSaveStatus(message) {
      const statusDiv = document.getElementById('saveStatus');
      if (statusDiv) {
        statusDiv.textContent = message;
        statusDiv.style.color = 'var(--success)';
        setTimeout(() => {
          statusDiv.textContent = '';
        }, 3000);
      }
    }
    
    // حفظ تلقائي كل دقيقة
    setInterval(() => {
      if (teams.length > 0 && document.getElementById('game').classList.contains('hidden') === false) {
        saveGameState();
        showSaveStatus('💾 حفظ تلقائي');
      }
    }, 60000); // كل 60 ثانية
  </script>
</body>
</html>
